<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sneaker Shop - Корзина</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-running"></i> Sneaker Shop</h1>
            <nav>
                <div class="nav-links">
                    <a href="index.html"><i class="fas fa-home"></i> Главная</a>
                    <a href="catalog.html"><i class="fas fa-shopping-bag"></i> Каталог</a>
                    <a href="cart.html" class="active"><i class="fas fa-shopping-cart"></i> Корзина <span id="cart-count" class="badge"></span></a>
                    <a href="orders.html"><i class="fas fa-receipt"></i> Заказы</a>
                    <a href="profile.html"><i class="fas fa-user"></i> Профиль</a>
                    <a href="admin.html" id="admin-link" style="display:none"><i class="fas fa-user-shield"></i> Админка</a>
                </div>
                <div class="auth-buttons">
                    <div id="user-info" class="user-info"></div>
                    <button id="logout-btn" class="btn btn-secondary" style="display:none">
                        <i class="fas fa-sign-out-alt"></i> Выйти
                    </button>
                    <button id="login-btn" class="btn">
                        <i class="fas fa-sign-in-alt"></i> Войти
                    </button>
                </div>
            </nav>
        </header>

        <main>
            <section class="page-header">
                <h2><i class="fas fa-shopping-cart"></i> Ваша корзина</h2>
                <p>Проверьте товары перед оформлением заказа</p>
            </section>

            <div class="cart-container">
                <div class="cart-content">
                    <div id="cart-items" class="cart-items-section">
                        <div class="loading-cart">
                            <div class="loading-spinner"></div>
                            <p>Загрузка корзины...</p>
                        </div>
                    </div>
                    
                    <div class="cart-summary">
                        <h3><i class="fas fa-receipt"></i> Сводка заказа</h3>
                        
                        <div class="summary-details">
                            <div class="summary-row">
                                <span>Товары (<span id="items-count">0</span> шт.)</span>
                                <span id="subtotal">0 ₽</span>
                            </div>
                            <div class="summary-row">
                                <span>Доставка</span>
                                <span id="delivery-cost">0 ₽</span>
                            </div>
                            <div class="summary-row">
                                <span>Скидка</span>
                                <span class="discount">-<span id="discount-amount">0</span> ₽</span>
                            </div>
                            <div class="summary-row total">
                                <span>Итого</span>
                                <span id="total-price">0 ₽</span>
                            </div>
                        </div>
                        
                        <div class="promo-code">
                            <input type="text" id="promo-input" placeholder="Промокод">
                            <button onclick="applyPromo()" class="btn btn-small">Применить</button>
                        </div>
                        
                        <button id="checkout-btn" onclick="proceedToCheckout()" class="btn btn-checkout" disabled>
                            <i class="fas fa-lock"></i> Перейти к оформлению
                        </button>
                        
                        <div class="secure-payment">
                            <p><i class="fas fa-shield-alt"></i> Безопасная оплата</p>
                            <div class="payment-methods">
                                <i class="fab fa-cc-visa"></i>
                                <i class="fab fa-cc-mastercard"></i>
                                <i class="fab fa-cc-mir"></i>
                                <i class="fab fa-cc-amex"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="empty-cart" class="empty-cart" style="display:none;">
                    <div class="empty-cart-icon">
                        <i class="fas fa-shopping-cart fa-4x"></i>
                    </div>
                    <h3>Ваша корзина пуста</h3>
                    <p>Добавьте товары из каталога, чтобы продолжить</p>
                    <a href="catalog.html" class="btn btn-large">
                        <i class="fas fa-shopping-bag"></i> Перейти в каталог
                    </a>
                </div>
            </div>
            
            <div class="cart-recommendations">
                <h3><i class="fas fa-fire"></i> Рекомендуем добавить</h3>
                <div id="recommended-items" class="recommended-grid">
                </div>
            </div>
        </main>

        <footer>
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Корзина</h4>
                    <a href="#">Как оформить заказ</a>
                    <a href="#">Условия возврата</a>
                    <a href="#">Оплата и доставка</a>
                </div>
                <div class="footer-section">
                    <h4>Поддержка</h4>
                    <p><i class="fas fa-phone"></i> 8-800-123-45-67</p>
                    <p>Ежедневно с 9:00 до 21:00</p>
                </div>
            </div>
            <p class="copyright">© 2024 Sneaker Shop. Все права защищены.</p>
        </footer>
    </div>

    <div id="notification" class="notification" style="display:none"></div>

    <script src="app.js"></script>
    <script>
        let cartItems = [];
        let sneakersMap = new Map();
        let deliveryCost = 300;
        let discount = 0;
        async function loadCart() {
            const token = localStorage.getItem('token');
            if (!token) {
                showEmptyCart();
                return;
            }

            try {
                const cartResponse = await fetch('http://localhost:5000/api/cart', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (cartResponse.ok) {
                    cartItems = await cartResponse.json();
                    
                    if (cartItems.length === 0) {
                        showEmptyCart();
                        return;
                    }

                    const sneakerIds = cartItems.map(item => item.sneakerId);
                    const sneakersResponse = await fetch('http://localhost:5000/api/sneakers');
                    
                    if (sneakersResponse.ok) {
                        const allSneakers = await sneakersResponse.json();
                        allSneakers.forEach(s => sneakersMap.set(s.id, s));
                        
                        displayCartItems();
                        updateSummary();
                        loadRecommendedItems();
                    }
                } else if (cartResponse.status === 401) {
                    showEmptyCart();
                }
            } catch (error) {
                console.error('Ошибка загрузки корзины:', error);
                showEmptyCart();
            }
        }
        function displayCartItems() {
            const container = document.getElementById('cart-items');
            const emptyCart = document.getElementById('empty-cart');
            
            container.innerHTML = '';
            
            cartItems.forEach(item => {
                const sneaker = sneakersMap.get(item.sneakerId);
                if (!sneaker) return;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item-card';
                itemDiv.innerHTML = `
                    <div class="cart-item-image">
                        <div class="color-circle" style="background-color: ${getColorHex(sneaker.color)}"></div>
                        <div class="size-badge">${sneaker.size}</div>
                    </div>
                    <div class="cart-item-details">
                        <h4>${sneaker.name}</h4>
                        <p class="item-color"><i class="fas fa-palette"></i> ${sneaker.color}</p>
                        <p class="item-price">${sneaker.price.toFixed(2)} ₽</p>
                        <p class="item-delivery ${sneaker.delivery ? 'free' : 'paid'}">
                            <i class="fas fa-shipping-fast"></i> ${sneaker.delivery ? 'Бесплатная доставка' : 'Платная доставка'}
                        </p>
                    </div>
                    <div class="cart-item-quantity">
                        <button onclick="updateQuantity(${item.id}, -1)" class="qty-btn" ${item.qty <= 1 ? 'disabled' : ''}>
                            <i class="fas fa-minus"></i>
                        </button>
                        <span class="qty-value">${item.qty}</span>
                        <button onclick="updateQuantity(${item.id}, 1)" class="qty-btn" ${item.qty >= sneaker.stock ? 'disabled' : ''}>
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="cart-item-total">
                        <span>${(sneaker.price * item.qty).toFixed(2)} ₽</span>
                    </div>
                    <div class="cart-item-actions">
                        <button onclick="removeFromCart(${item.id})" class="btn-remove">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button onclick="saveForLater(${sneaker.id})" class="btn-save">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                `;
                container.appendChild(itemDiv);
            });

            emptyCart.style.display = 'none';
            document.getElementById('checkout-btn').disabled = false;
        }
        async function updateQuantity(itemId, delta) {
            const token = localStorage.getItem('token');
            const item = cartItems.find(i => i.id === itemId);
            
            if (!item) return;
            
            const newQty = item.qty + delta;
            const sneaker = sneakersMap.get(item.sneakerId);
            
            if (newQty < 1 || newQty > sneaker.stock) return;
            
            try {
                const response = await fetch(`http://localhost:5000/api/cart/${itemId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    await fetch('http://localhost:5000/api/cart', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ 
                            sneakerId: item.sneakerId, 
                            qty: newQty 
                        })
                    });
                    
                    await loadCart();
                    updateCartCount();
                }
            } catch (error) {
                console.error('Ошибка обновления количества:', error);
            }
        }
        async function removeFromCart(itemId) {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`http://localhost:5000/api/cart/${itemId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    showNotification('Товар удален из корзины', 'info');
                    await loadCart();
                    updateCartCount();
                }
            } catch (error) {
                console.error('Ошибка удаления:', error);
            }
        }
        function updateSummary() {
            let subtotal = 0;
            let itemsCount = 0;
            let freeDelivery = true;
            
            cartItems.forEach(item => {
                const sneaker = sneakersMap.get(item.sneakerId);
                if (sneaker) {
                    subtotal += sneaker.price * item.qty;
                    itemsCount += item.qty;
                    if (!sneaker.delivery) freeDelivery = false;
                }
            });
            
            const delivery = freeDelivery ? 0 : deliveryCost;
            const total = subtotal + delivery - discount;
            
            document.getElementById('items-count').textContent = itemsCount;
            document.getElementById('subtotal').textContent = subtotal.toFixed(2) + ' ₽';
            document.getElementById('delivery-cost').textContent = delivery === 0 ? 'Бесплатно' : delivery + ' ₽';
            document.getElementById('discount-amount').textContent = discount.toFixed(2);
            document.getElementById('total-price').textContent = total.toFixed(2) + ' ₽';
        }
        function applyPromo() {
            const promo = document.getElementById('promo-input').value;
            
            if (promo === 'WELCOME10') {
                discount = cartItems.reduce((sum, item) => {
                    const sneaker = sneakersMap.get(item.sneakerId);
                    return sum + (sneaker.price * item.qty * 0.1);
                }, 0);
                
                showNotification('Промокод успешно применен! Скидка 10%', 'success');
                updateSummary();
            } else if (promo) {
                showNotification('Промокод недействителен', 'error');
            }
        }
        async function loadRecommendedItems() {
            try {
                const response = await fetch('http://localhost:5000/api/sneakers?sort=stock_desc&limit=4');
                if (response.ok) {
                    const sneakers = await response.json();
                    const container = document.getElementById('recommended-items');
                    
                    container.innerHTML = '';
                    sneakers.slice(0, 4).forEach(sneaker => {
                        if (cartItems.some(item => item.sneakerId === sneaker.id)) return;
                        
                        const card = document.createElement('div');
                        card.className = 'recommended-card';
                        card.innerHTML = `
                            <div class="rec-image">
                                <div class="color-circle" style="background-color: ${getColorHex(sneaker.color)}"></div>
                            </div>
                            <h5>${sneaker.name}</h5>
                            <p class="rec-price">${sneaker.price.toFixed(2)} ₽</p>
                            <button onclick="addToCart(${sneaker.id})" class="btn btn-small">
                                <i class="fas fa-cart-plus"></i> Добавить
                            </button>
                        `;
                        container.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('Ошибка загрузки рекомендаций:', error);
            }
        }
        function proceedToCheckout() {
            if (cartItems.length === 0) {
                showNotification('Корзина пуста', 'error');
                return;
            }
            window.location.href = 'checkout.html';
        }
        function showEmptyCart() {
            document.getElementById('cart-items').innerHTML = '';
            document.getElementById('empty-cart').style.display = 'block';
            document.getElementById('checkout-btn').disabled = true;
            document.querySelector('.cart-recommendations').style.display = 'none';
        }
        function saveForLater(sneakerId) {
            showNotification('Товар добавлен в избранное', 'success');
        }
        function getColorHex(color) {
            const colors = {
                'White': '#ffffff', 'Black': '#000000', 'Red': '#e74c3c',
                'Blue': '#3498db', 'Green': '#2ecc71', 'Grey': '#95a5a6',
                'Brown': '#a0522d', 'Beige': '#f5deb3', 'Yellow': '#f1c40f',
                'Orange': '#e67e22', 'Navy': '#2c3e50', 'Silver': '#bdc3c7',
                'Maroon': '#800000'
            };
            return colors[color] || '#3498db';
        }
        document.addEventListener('DOMContentLoaded', () => {
            loadCart();
            checkAuth();
            updateCartCount();
        });
    </script>
</body>
</html>